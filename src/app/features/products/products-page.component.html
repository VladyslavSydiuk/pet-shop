<div class="marketplace-layout">

  <div class="content">
    <!-- Лівий вертикальний дашборд -->
    <aside class="category-sidebar">
      <button
        mat-button
        [class.active]="selectedCategory() === null"
        (click)="onCategoryChange(null)"
      >
        Усі
      </button>

      <button
        mat-button
        *ngFor="let category of categories()"
        [class.active]="selectedCategory() === category"
        (click)="onCategoryChange(category)"
      >
        {{ category }}
      </button>
    </aside>

    <!-- Список товарів -->
    <main class="product-area">
      <div class="category-summary" style="padding: 12px 16px;">
        <strong>{{ selectedCategory() || 'Усі' }}</strong>
        <span> — {{ totalItems() }} товарів</span>
        <span *ngIf="search.searchQuery()"> • пошук: "{{ search.searchQuery() }}"</span>
      </div>
      <ul class="product-list">
        <li *ngFor="let product of filteredProducts()">
          <div class="product-card" @fadeIn>
            <h3 class="product-title">{{ product.productName }}</h3>
            <img
              class="product-image"
              [src]="toImageUrl(product.avatarUrl)"
              [alt]="product.productName"
              loading="lazy"
              (error)="onImgError($event)"
            />
            <div class="product-info">
              <span class="price">{{ product.price }} грн</span>
              <ng-container *ngIf="getRatingSummary(product.id) | async as rs">
                <app-star-rating [value]="rs.avg" [readonly]="true"></app-star-rating>
                <span class="rating-count">({{ rs.count }})</span>
              </ng-container>
              <span
                class="status-badge"
                [ngStyle]="{
                  'background': (product.productStatus === 'AVAILABLE' ? '#e6f4ea' : (product.productStatus === 'UNAVAILABLE' ? '#fdecea' : '#eef2ff')),
                  'color': (product.productStatus === 'AVAILABLE' ? '#137333' : (product.productStatus === 'UNAVAILABLE' ? '#b3261e' : '#1a1a9b')),
                  'padding': '2px 8px', 'border-radius': '12px', 'margin-left': '8px', 'font-size': '12px'
                }"
              >
                {{ product.productStatus || (product.stock === 0 ? 'UNAVAILABLE' : 'AVAILABLE') }}
              </span>
              <span class="stock" style="margin-left: 8px; font-size: 12px;">
                <ng-container *ngIf="product.stock !== undefined; else noStock">
                  <ng-container *ngIf="product.stock as s">
                    <span *ngIf="s > 0; else outOfStock">В наявності: {{ s }}</span>
                  </ng-container>
                </ng-container>
                <ng-template #noStock></ng-template>
                <ng-template #outOfStock>Немає в наявності</ng-template>
              </span>
            </div>
            <div class="actions">
              <button mat-raised-button color="primary"
                      [disabled]="!isBuyEnabled(product)"
              >Купити</button>
              <button mat-stroked-button color="accent" [routerLink]="['/product', product.id]">Деталі</button>
            </div>
          </div>
        </li>
      </ul>

      <!-- Pagination Controls -->
      <div class="pagination-container">
        <mat-paginator
          [length]="totalItems()"
          [pageSize]="pageSize()"
          [pageIndex]="pageIndex()"
          [pageSizeOptions]="[5, 10, 20, 50]"
          (page)="handlePageEvent($event)"
          aria-label="Select page">
        </mat-paginator>
      </div>
    </main>
  </div>
</div>
